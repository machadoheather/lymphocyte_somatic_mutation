---
title: "AX001_filtered indel filtering July 2019"
output: html_document
---
<style type="text/css">
body{ /* Normal  */
      font-size: 10px;
  }
td {  /* Table  */
  font-size: 8px;
}
h1.title {
  font-size: 24px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 16px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 16px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 12px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 10px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 10px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE, cache.lazy = FALSE, fig.path="./graphics/plot",autodep=TRUE,fig.width=5, fig.height=4)
knitr::opts_knit$set(root.dir = '/Users/hm8/sanger/lymphocyteExpansionSequenceAnalysis/scripts/scripts_April2021/01_variant_filtering')
library(ggplot2)
library(cowplot)
library(caTools)
library(reshape2)
library(dplyr)
library(data.table)
library(diptest)
library(quantmod)
```

## Reading in raw data
```{r, fig.width=2.5, fig.height=2}
group = "AX001"
groupname = paste(group, "_indel", sep = "")

## Read in sample info
metadata = read.csv(paste("../",group,"/",group,"_sampleinfo.csv", sep=""), stringsAsFactors = FALSE)
colnames(metadata)[1] = "colony"


## Original VAFs (mutation ID as rowname)
HQdp1 = read.table(paste("/Users/hm8/sanger/lymphocyteExpansionSequenceAnalysis/AX001/AX001_indel_totalDP.txt", sep=""), stringsAsFactors = F, header=T, check.names=F)[,metadata$colony]
HQalt1 = read.table(paste("/Users/hm8/sanger/lymphocyteExpansionSequenceAnalysis/AX001/AX001_indel_alternateDP.txt", sep=""), stringsAsFactors = F, header=T, check.names=F)[,metadata$colony]

sample_names = colnames(HQdp1)
Nsamples = length(sample_names)
Nsamples

HQdpNA = HQdp1
HQdpNA[HQdp1==0] = NA
HQfreq1 = HQalt1/HQdpNA
nrow(HQfreq1)

## Filter out most conspicuous germline mutations with mean VAF threshold
meanfreq = apply(HQfreq1, MARGIN=1, FUN=mean, na.rm=TRUE)
autoKeep = intersect(which(meanfreq < 0.4), grep("X|Y", rownames(HQdp1), invert=TRUE))
sexKeep = intersect(which(meanfreq < 0.8), grep("X|Y", rownames(HQdp1)))
HQdp40 = HQdp1[c(autoKeep, sexKeep),]
HQalt40 = HQalt1[c(autoKeep, sexKeep),]
HQfreq40 = HQfreq1[c(autoKeep, sexKeep),]
nrow(HQfreq40)
```


## Use SNV analysis to filter colonies (<6x dp, polyclonal, 10 HSCs)
```{r}
meandp = apply(HQdp1, MARGIN=2, FUN=mean, na.rm=TRUE)
# removed due to low dp: none
# removed previous analysis: "T1_A3"
# removed due to contamination: B11_G2

dpkeep = !(sample_names %in% c("T1_A3", "B11_G2") )
sample_names = sample_names[dpkeep]
Nsamples = length(sample_names)
Nsamples
hist(meandp, main="Mean dp per colony", breaks=20, xlab="dp")

HQdp = HQdp40[,dpkeep]
HQalt = HQalt40[,dpkeep]
HQfreq = HQfreq40[,dpkeep]
```

## Overdispersion filter
```{r}
bb_df = na.omit(read.table(paste("/Users/hm8/sanger/lymphocyteExpansionSequenceAnalysis/AX001/AX001_indel_rho.txt", sep=""), stringsAsFactors = FALSE, header=TRUE))
rho_est = as.numeric(bb_df$rho)
pvalue = as.numeric(bb_df$pvalue)

dip.test(log(rho_est))$p.value # 0
dens1 = density(-log(rho_est))
dens1df = data.frame(xval = as.numeric(dens1$x), yval=as.numeric(dens1$y))

peak1 = findPeaks(dens1$y)
val1 = findValleys(dens1$y)
{plot(dens1)
abline(v=dens1$x[val1], col="black")
}
my_logval = dens1$x[val1][1]
{plot(dens1)
abline(v=dens1$x[val1], col="black")
abline(v=my_logval, col="red")}
my_valley2 = my_logval
my_valley2

{pdf(paste("figures/", groupname,".overdist_cutoff_indel.pdf", sep="") )
plot(dens1)
abline(v=dens1$x[val1], col="black")
abline(v=my_valley2, col="red")}
```

## Setting threshold
```{r, message=FALSE, warning=FALSE}
log_rho_threshold = -my_valley2
pvalue_threshold = 0.1
{plot(log(rho_est),pvalue, col=rgb(0,0,0,0.5))
  abline(h=pvalue_threshold, col="blue")
  abline(v=log_rho_threshold, col="red")}
```

## Filtering based on overdispersion test
```{r, message=FALSE, warning=FALSE}
###### Checking the cutoffs
flt_rho_toss = bb_df$ID[log(rho_est)<=log_rho_threshold|pvalue>=pvalue_threshold]
flt_rho_keep = bb_df$ID[log(rho_est)>log_rho_threshold & pvalue<pvalue_threshold] 
length(flt_rho_keep)/(length(flt_rho_keep)+length(flt_rho_toss)) # Keep 

HQalt_keep = subset(HQalt, (rownames(HQalt) %in% flt_rho_keep) )
HQfreq_keep = subset(HQfreq, (rownames(HQfreq) %in% flt_rho_keep) )
```


## Identifying low frequency sites (potenitally invitro mutations) and min alt < 2
```{r, message=FALSE, warning=FALSE}
tmp = data.frame(HQfreq_keep, HQalt_keep)

meanVAF_alt2_keep = apply(tmp, MARGIN=1, FUN=function(X) mean( X[1:Nsamples][X[(Nsamples+1):(2*Nsamples)]>=2] ) )
meanVAF_alt2_keep[is.nan(meanVAF_alt2_keep)] = 0
Nsamples_alt2_keep = apply(tmp, MARGIN=1, FUN=function(X) length( X[1:Nsamples][ X[(Nsamples+1):(2*Nsamples)]>=2 ] ) )
meanVAF_alt2_freq20_keep = apply(tmp, MARGIN=1, FUN=function(X) mean( X[1:Nsamples][    X[1:Nsamples]>0.2 & X[(Nsamples+1):(2*Nsamples)]>=2 ] ) )
meanVAF_alt2_freq20_keep[is.nan(meanVAF_alt2_freq20_keep)] = 0
Nsamples_alt2_freq20_keep = apply(tmp, MARGIN=1, FUN=function(X) length( X[1:Nsamples][    X[1:Nsamples]>0.2 & X[(Nsamples+1):(2*Nsamples)]>=2 ] ) )

HQfreq_keep$meanVAF_alt2 = as.numeric(meanVAF_alt2_keep)
HQfreq_keep$Nsamples_alt2 = Nsamples_alt2_keep
HQfreq_keep$meanVAF_alt2_freq20 = as.numeric(meanVAF_alt2_freq20_keep)
HQfreq_keep$Nsamples_alt2_freq20 = Nsamples_alt2_freq20_keep
```

## Plotting effect of filter
```{r, message=FALSE, warning=FALSE}
{hist( as.numeric(HQfreq_keep$meanVAF_alt2[HQfreq_keep$Nsamples_alt2>1]), breaks=50, freq=F, main="Mean VAF (alt2), keep", xlim=c(0,1), xlab="VAF")
hist( as.numeric(HQfreq_keep$meanVAF_alt2[HQfreq_keep$Nsamples_alt2==1]), breaks=50, freq=F, col=rgb(1,0,0,0.5), add=TRUE)
legend("topright", fill=c("white", rgb(1,0,0,0.5)), legend=c("Shared","Private"))}

{hist( as.numeric(HQfreq_keep$meanVAF_alt2_freq20[HQfreq_keep$Nsamples_alt2_freq20>1]), breaks=50, freq=F, main="Mean VAF (alt2 freq20), keep", xlim=c(0,1), xlab="VAF")
hist( as.numeric(HQfreq_keep$meanVAF_alt2_freq20[HQfreq_keep$Nsamples_alt2_freq20==1]), breaks=50, freq=F, col=rgb(1,0,0,0.5), add=TRUE)
legend("topright", fill=c("white", rgb(1,0,0,0.5)), legend=c("Shared","Private"))}
```

## Shared mutations among colonies 
```{r}
t1 = table(HQfreq_keep$Nsamples_alt2_freq20)
t0 = data.frame(Ncolonies=as.numeric(names(t1)[names(t1)>0]), Nsnvs = t1[names(t1)>0])
ggplot(t0)+
  geom_point(aes(as.numeric(Ncolonies), Nsnvs.Freq))+
  scale_y_continuous(trans='log10') + 
  ylab("# SNVs (log)") + 
  xlab("# colonies sharing SNV") 
ggsave(file=paste("figures/colonysharing_", groupname,".pdf", sep=""), width=6,height=4)
```

## Filtering out SNVs identified based on low VAF or alt depth
```{r, message=FALSE, warning=FALSE}
## Assigning NAs to anything below cutoff
HQfreqsomNA = HQfreq_keep[,1:Nsamples]
HQfreqsomNA[ (tmp[, 1:Nsamples]<=0.2 | tmp[, (Nsamples+1):(2*Nsamples)]<2) ] = NA  ## Anytime the alt is <2 or freq <0.2

r1 = do.call(rbind, lapply(rownames(HQfreqsomNA), FUN=function(X) unlist(strsplit(X, ":")) ) )
r2 = do.call(rbind, lapply(r1[,2], FUN=function(X) unlist(strsplit(X, "_")) ) )
r3 = do.call(rbind, lapply(r2[,2], FUN=function(X) unlist(strsplit(X, "/")) ) )
HQfreqsomNA2 = data.frame(ID=rownames(HQfreqsomNA), chr=r1[,1], pos=r2[,1], ref=r3[,1], mut=r3[,2], HQfreqsomNA)
colnames(HQfreqsomNA2) = c("ID", "chr", "pos", "ref", "mut", colnames(HQfreqsomNA) )
```


## Separating by sample
```{r, message=FALSE, warning=FALSE}
somsample_list2 = list()
for (i in 1:length(sample_names)){
  ind=i+5 ## for samples 6-10
  focalfreq = data.frame(HQfreqsomNA2[,1:5], HQ.alt.freq=HQfreqsomNA2[,ind])
  somsample_list2[[i]] = na.omit(focalfreq)
}
names(somsample_list2) = sample_names
```

## Number of mutations per colony (pre-dp adjustment)
```{r}
mut_per_colony = data.frame(colony=names(somsample_list2), Nmut_indel = unlist(lapply(somsample_list2, FUN=nrow)))
hist(mut_per_colony$Nmut, breaks=50, xlab="# Indels", ylab="Counts (# colonies)", main="")
```

## Reading in cell type metadata
```{r, message=FALSE, warning=FALSE}
metadata = read.csv(paste("meandp_cellnumber_colony_", group, ".csv", sep=""), stringsAsFactors = FALSE)
m1 = merge(metadata, sample_names, by=1, all.y=TRUE)
table(m1$Cell.type2)
m3 = merge(m1, mut_per_colony, by=1)
```

## Save objects
```{r, message=FALSE, warning=FALSE}
save(somsample_list2, sample_names, file=paste(groupname, "_somsample_list2.Rdata", sep="") )
write.table(m3, file=paste("meandp_cellnumber_colony_", groupname, ".csv", sep=""), quote=FALSE, col.names=TRUE, sep=",")
```

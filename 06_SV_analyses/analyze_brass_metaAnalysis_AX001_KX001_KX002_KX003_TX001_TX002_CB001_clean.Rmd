---
title: "analyze_brass_metaAnalysis_AX001_KX001_KX002_KX003_TX001_TX002_CB001"
output: pdf_document
---

# May 2019
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE, fig.path="./graphics/plot",autodep=TRUE,fig.width=6, fig.height=3)
knitr::opts_knit$set(root.dir = '/Users/hm8/sanger/lymphocyteExpansionSequenceAnalysis/metaAnalysis_AX001_KX001_KX002_KX003_TX001_TX002_CB001_March2021')
library(ggplot2)
library(reshape2)
library(data.table)

```


# WORK WITH THE CURATED FILE (also has ASCAT results)
```{r}

# Read in brass results
brassfiltered = read.csv(file="brass_ascat_curated.csv", stringsAsFactors = F, header=T)  # 1160   91

# load metadata
m3 = read.table("colonyinfo_AX001_KX001_KX002_KX003_TX001_TX002_CB001.txt", header=T, stringsAsFactors = F, sep="\t")

# Include ASCAT results (only 12) and merge brass results with colony info
brassfiltered_m3 = merge(brassfiltered, m3, by.x="sample", by.y="colony") # 18 rows omitted (due to those colonies being omitted in final analysis) #  1142  102
hsc_deletion = subset(brassfiltered, colony=="PD43974ay")
```


# Plotting SVs
```{r}
brassfilteredTP = subset(brassfiltered, Correct != FALSE)
mycolonies = unique(brassfilteredTP$colony)
ntot = nvdj = nnonvdj = vector()
for (i in 1:length(mycolonies)){
  focal = brassfilteredTP[brassfilteredTP$colony %in% mycolonies[i],]
  #focalna = na.omit(focal)  # not sure why I intially did this, but it throws out real SVs
  focalna = focal
  ntot[i] = nrow(focalna)
  if (ntot[i]==0){
    nvdj[i] = nnonvdj[i] = 0
  } else {
    nvdj[i] = sum(focalna$VDJlocus != FALSE)
    nnonvdj[i] = sum(focalna$VDJlocus == FALSE)
  }
}
Nbycolony = data.frame(colony=mycolonies, N.SV=ntot, N.VDJ=nvdj, N.nonVDJ=nnonvdj)

## load in 
load("/Users/hm8/sanger/lymphocyteExpansionSequenceAnalysis/metaAnalysis_pcawg_mm_AX001_KX001_KX002_KX003_TX001_TX002_CB001_March2021/sigfit/sigs_union_hdp_sigprofiler_min10percent/sig_prop_type.Rdata")
NbycolonyDF = merge(Nbycolony, sig_prop_type, by=1)
```



# Numbers and percents of SVs by subset
```{r}
#brassfiltered_allanalyzed = merge(brassfilteredTP, sig_prop_type_brassnames, by.x="sample", by.y="colony", all.y=TRUE) # 1241   107
brassfiltered_allanalyzed = merge(brassfilteredTP, sig_prop_type, by.x="colony", by.y= "samp_names") # 1241   107
brassfiltered_allanalyzed$Cell.type2 = brassfiltered_allanalyzed$Cell.type2.y
brassfiltered_allanalyzed2 = subset(brassfiltered_allanalyzed, Cell.type2 %in% c("HSC","Naive T","Memory T","Naive B","Memory B"))
brassfiltered_allanalyzed2$Cell.type2 = factor(brassfiltered_allanalyzed2$Cell.type2 , levels=unique(brassfiltered_allanalyzed2$Cell.type2 ))
table(brassfiltered_allanalyzed2$Cell.type2)


# number of each class of SV
table(brassfiltered_allanalyzed2$svclass)

# proportion of each SV
table(brassfiltered_allanalyzed2$svclass)/sum(table(brassfiltered_allanalyzed2$svclass))

# proportion of each non-VDJ SV
nonVDJ = subset(brassfiltered_allanalyzed2, VDJlocus==FALSE)
table(nonVDJ$svclass)/sum(table(nonVDJ$svclass))


NbycolonyDF_allanalyzed = merge(Nbycolony, subset(sig_prop_type, Cell.type2 %in% c("HSC","Naive T","Memory T","Naive B","Memory B")), by.x="colony", by.y= "samp_names", all.y=TRUE) # 780  30
NbycolonyDF_allanalyzed[is.na(NbycolonyDF_allanalyzed$N.SV),]$N.SV = 0
NbycolonyDF_allanalyzed[is.na(NbycolonyDF_allanalyzed$N.VDJ),]$N.VDJ = 0
NbycolonyDF_allanalyzed[is.na(NbycolonyDF_allanalyzed$N.nonVDJ),]$N.nonVDJ = 0
NbycolonyDF_allanalyzed = data.frame(rbind(NbycolonyDF_allanalyzed, c(hsc_deletion$colony, 1, 0, 1, "HSC", "AX001", rep(0, times=8), "HSC" )))

subsets = unique(NbycolonyDF_allanalyzed$Cell.type2)
N=p.sv=p.sv.nonvdj=p.del=p.del.nonvdj=mean.per.genome.sv=mean.per.genome.sv.nonvdj=mean.per.genome.sv.vdj=vector()
for (i in 1:length(subsets)){
  focal=subset(NbycolonyDF_allanalyzed, Cell.type2==subsets[i])
  N[i] = nrow(focal)
  p.sv[i] = mean(focal$N.SV>0)
  p.sv.nonvdj[i] = mean(focal$N.nonVDJ>0)
  mean.per.genome.sv[i] = mean(as.numeric(focal$N.SV))
  mean.per.genome.sv.vdj[i] = mean(as.numeric(focal$N.VDJ))
  mean.per.genome.sv.nonvdj[i] = mean(as.numeric(focal$N.nonVDJ))
}
focal=subset(NbycolonyDF_allanalyzed, Cell.type2!="HSC")
N[6] = nrow(focal)
p.sv[6] = mean(focal$N.SV>0)
p.sv.nonvdj[6] = mean(focal$N.nonVDJ>0)
mean.per.genome.sv[6] = mean(as.numeric(focal$N.SV))
mean.per.genome.sv.nonvdj[6] = mean(as.numeric(focal$N.nonVDJ))
mean.per.genome.sv.vdj[6] = mean(as.numeric(focal$N.VDJ))

summarySV = data.frame(Cell.type2=c(as.character(subsets),"lymph"), N, p.sv, p.sv.nonvdj,mean.per.genome.sv,mean.per.genome.sv.vdj,mean.per.genome.sv.nonvdj)
summarySV2 = summarySV[1:5,]
summarySV2$Cell.type2 = factor(summarySV2$Cell.type2, levels=c("HSC","Naive B","Memory B","Naive T","Memory T"))
summarySV2

fisher.test(matrix(c(summarySV[summarySV$Cell.type2=="HSC",]$N*summarySV[summarySV$Cell.type2=="HSC",]$p.sv.nonvdj,
                   summarySV[summarySV$Cell.type2=="HSC",]$N*(1-summarySV[summarySV$Cell.type2=="HSC",]$p.sv.nonvdj),
                   summarySV[summarySV$Cell.type2=="lymph",]$N*summarySV[summarySV$Cell.type2=="lymph",]$p.sv.nonvdj,
                   summarySV[summarySV$Cell.type2=="lymph",]$N*(1-summarySV[summarySV$Cell.type2=="lymph",]$p.sv.nonvdj)), ncol=2, byrow=TRUE ))$p.value  # 9.006286e-05


## Need to use better regression model, but will remain not sig. 
# summary(lm(N.SV~Age+Cell.type2, data=NbycolonyDF_allanalyzed))
# for (i in 1:length(subsets)){
#   focal=subset(NbycolonyDF_allanalyzed, Cell.type2==subsets[i])
#   print(as.character(subsets[i]))
#   print(summary(lm(N.SV~Age, data=focal)))
#   print(summary(lm(N.nonVDJ~Age, data=focal)))
# }


```



# Plotting SVs
```{r}

brassfilteredTP = rbind(subset(brassfiltered, Correct != FALSE), hsc_deletion) #add the one hsc with a SV
brassfilteredTP$VDJlocus[brassfilteredTP$VDJlocus==""] = FALSE
brassfilteredTP$VDJlocusTF = TRUE
brassfilteredTP$VDJlocusTF[brassfilteredTP$VDJlocus==FALSE] = FALSE
brassfilteredTP$svclass2 = NA
brassfilteredTP$svclass2[brassfilteredTP$svclass %in% c("ascat_gain","ascat_partial_gain","ascat_partial_loss","ascat_uniparental_disomy")] = "gain/loss"
brassfilteredTP$svclass2[brassfilteredTP$svclass %in% c("bridge_of_templated_insertions","Cycle_templated_insertions","local_3_jump","chromoplexy")] = "other"
brassfilteredTP$svclass2[brassfilteredTP$svclass %in% c("deletion")] = "deletion"
brassfilteredTP$svclass2[brassfilteredTP$svclass %in% c("foldback_inversion", "inversion", "reciprocal_inversion")] = "inversion"
brassfilteredTP$svclass2[brassfilteredTP$svclass %in% c("tandem-duplication")] = "tandem-dup"
brassfilteredTP$sv
class2[brassfilteredTP$svclass %in% c("reciprocal_translocation","translocation","unbalanced_translocation")] = "translocation"

sig_prop_type_focal = subset(sig_prop_type2, Cell.type2 %in% c("HSC","Naive B","Memory B","Naive T","Memory T") )
sig_prop_type_focal2 = rbind(sig_prop_type_focal, unlist(c(hsc_deletion[,c("colony",   "meandp", "Donor",   "CellType", "Cell.type2", "Tissue")], rep(0, times=16) )) )
mycolonies = sig_prop_type_focal2$colony # include HSC deletion
myclasses = unique(brassfilteredTP$svclass2)
npercolonyVDJ = npercolonynonVDJ = npercolony = matrix(nrow=length(mycolonies), ncol=length(myclasses))
for (colony in 1:length(mycolonies)){
  for (class in 1:length(myclasses)){
      mysum1 = sum(brassfilteredTP$colony==mycolonies[colony] & brassfilteredTP$svclass2==myclasses[class] & brassfilteredTP$VDJlocusTF==TRUE)      
      npercolonyVDJ[colony, class] = mysum1
      mysum2 = sum(brassfilteredTP$colony==mycolonies[colony] & brassfilteredTP$svclass2==myclasses[class] & brassfilteredTP$VDJlocusTF==FALSE)
      npercolonynonVDJ[colony, class] = mysum2
      mysum3 = sum(brassfilteredTP$colony==mycolonies[colony] & brassfilteredTP$svclass2==myclasses[class])
      npercolony[colony, class] = mysum3
  }
}


mylist = list(npercolonyVDJ, npercolonynonVDJ, npercolony)
outlist = list()
for (i in 1:3){
    focal = mylist[[i]]
    focal[is.na(mylist[[i]])] = 0
    outlist2 = list()
    for (j in 1:6){
      outlist2[[j]] = tapply(focal[,j], INDEX=sig_prop_type_focal2$Cell.type2, FUN=mean)
    }    
    df1 = data.frame(do.call(cbind, outlist2))
    colnames(df1) = myclasses
    outlist[[i]] = df1
}
myvdj = data.frame(outlist[[1]])
myvdj$dataset = "Ig/TCR"
mynonvdj = data.frame(outlist[[2]])
mynonvdj$dataset = "non-Ig/TCR"
mytotal = data.frame(outlist[[3]])
mytotal$dataset = "total"
myboth = rbind(myvdj, mynonvdj)
myboth$celltype = c("Memory B", "Naive B", "HSC", "Memory T", "Naive T","Memory B", "Naive B", "HSC", "Memory T", "Naive T")
myboth$celltype = factor(myboth$celltype, levels=c("HSC","Naive B", "Memory B", "Naive T",  "Memory T"))
myboth$dataset = factor(myboth$dataset, levels=c("Ig/TCR","non-Ig/TCR"))
mybothmelt = melt(myboth, id.vars=c("dataset" , "celltype"))
mybothmelt$variable = factor(mybothmelt$variable, levels=c("deletion", "inversion", "tandem.dup", "translocation",  "gain.loss","other") )

ggplot(mybothmelt, aes(variable, value, fill=dataset))+
  geom_bar(stat="identity", width=0.8)+
  facet_wrap(.~celltype, nrow=1)+
  #scale_fill_manual("",values=c("#1b9e77","#e7298a"))+
  #scale_fill_manual("",values=c("#de77ae","#1b9e77"))+
  scale_fill_manual("",values=c("#df65b0","#005a32"))+
  theme_bw()+
  scale_y_continuous(expand = expand_scale(mult=c(0,0.05)) )+
  xlab("")+
  ylab("Mean SV per genome")+
  #theme(strip.text = element_text(hjust = 0, size=10, face="bold"),
  theme(strip.text = element_text(hjust = 0, size=10),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black"),
        axis.text=element_text(size=8),
        axis.title=element_text(size=10),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.text=element_text(size=8),
        legend.key.size = unit(0.35, 'cm'))
#ggsave("N_sv_by_celltype_VDJ_SVtype.pdf", width=8.6,height=2.5)
```
  



# SV and signature regressions
```{r}
NbycolonyDF_allanalyzed_nonHSC = NbycolonyDF_allanalyzed[NbycolonyDF_allanalyzed$Cell.type2!="HSC",]
summary(lm(Nmut_adj_as_new~N.SV,data=NbycolonyDF_allanalyzed_nonHSC))
summary(lm(Nmut_adj_as_new~N.VDJ,data=NbycolonyDF_allanalyzed_nonHSC))
summary(lm(Nmut_adj_as_new~N.nonVDJ,data=NbycolonyDF_allanalyzed_nonHSC))

subsets2 = subsets[c(1,2,4,5)]
pval.sig = matrix(ncol=4, nrow=10)
r2.sig = matrix(ncol=4, nrow=10)
coef.sig = matrix(ncol=4, nrow=10)
colnames(pval.sig) = subsets2
rownames(pval.sig) = colnames(NbycolonyDF_allanalyzed_nonHSC)[13:22]
colnames(r2.sig) = subsets2
rownames(r2.sig) = colnames(NbycolonyDF_allanalyzed_nonHSC)[13:22]
colnames(coef.sig) = subsets2
rownames(coef.sig) = colnames(NbycolonyDF_allanalyzed_nonHSC)[13:22]
for (i in 1:4){
  focal = subset(NbycolonyDF_allanalyzed_nonHSC, Cell.type2==subsets2[i]) 
  for (j in 1:10){
    pval.sig[j,i] = summary(lm(focal[,12+j]~focal$N.nonVDJ) )$coefficients[2,4]
    r2.sig[j,i] = summary(lm(focal[,12+j]~focal$N.nonVDJ) )$adj.r.squared
    coef.sig[j,i] = summary(lm(focal[,12+j]~focal$N.nonVDJ) )$coefficients[2,1]
  }
}


# T memory and S7
ggplot(subset(NbycolonyDF_allanalyzed, Cell.type2=="T Memory"), aes(S7, N.nonVDJ))+
  geom_point()


ggplot(subset(NbycolonyDF_allanalyzed, Cell.type2=="T Memory"), aes(Nsig7, N.nonVDJ))+
  geom_point()

ggplot(subset(NbycolonyDF_allanalyzed, Cell.type2=="B Memory"), aes(Nsig9, N.nonVDJ))+
  geom_point(alpha=0.5)

```


# Writing a file of the new SVs
```{r}
old_brass = read.table("../../metaAnalysis_ARG_KX001_KX002_tonsilMS_tonsilPS_stemcellCB2_ARGtreg/brass_ARG_KX001_KX002_tonsilMS_tonsilPS_stemcellCB2_ARGtreg/brassfiltered_metadata_May2019.txt", header=T, stringsAsFactors = F, sep="\t")
new_brass = subset(brassfiltered_m3, !(sample %in% old_brass$sample) )
#write.table(new_brass, file="brassfiltered_metadata_extra_July2019.txt", col.names = T, row.names = F, quote=F, sep="\t")
```


# Statistical tests: calculate # SVs per colony
```{r}
# check for duplicates:
brassfilteredTP$ID = paste(brassfilteredTP$chr1, brassfilteredTP$start1, brassfilteredTP$start2, sep="_")
brassfilteredTP$IDsample = paste(brassfilteredTP$chr1, brassfilteredTP$start1, brassfilteredTP$start2, brassfilteredTP$sample, sep="_")
mydups = brassfilteredTP[duplicated(brassfilteredTP$ID),]
uniquedups = unique(mydups$ID)
i=1
brassfilteredTP[brassfilteredTP$ID == uniquedups[i], ]

# shared ancestrally or not double counting reciprocal inversions
# also removed ascat identified loss/gains
IDsample2remove = c("12_55681021_55985338_PD40521sp", "2_57857473_57861064_PD40521th","5_131058177_142403966_PD40667uo","5_131058177_142403966_PD40667uo","11_63923769_64542126_PD43974az", "11_63923769_64542126_PD43974bf","11_63923769_64542126_PD43974bn","11_63923769_64542126_PD43974cp","7_38295993_38369948_T3_B5","14_22466407_22964894_PD40521tj","2_NA_NA_PD40521vj","2_NA_NA_PD40521tz","2_NA_NA_PD40521te")
brassfilteredTPnodup = brassfilteredTP[!(brassfilteredTP$IDsample %in% IDsample2remove), ]
brassfilteredTPnodupFinal = subset(brassfilteredTPnodup, sample %in% m3final$colony)
brassfilteredTPFinalNonASCAT = brassfilteredTPFinal[grep(brassfilteredTPFinal$svclass, invert=T, pattern="ascat"), ]

m3final = subset(m3, Cell.type2 %in% c("HSC","T Memory","B Memory","T Naive","B Naive","Treg")) #717
brassfilteredTPFinal = subset(brassfilteredTP, sample %in% m3final$colony)
brassfilteredTP_allcolonies = merge(m3final, brassfilteredTPFinalNonASCAT, by.x="colony",by.y="sample", all.x=TRUE)
SVperColony = brassfilteredTP_allcolonies %>%
  group_by(colony) %>%
  summarise(nSV = sum(!(is.na(chr1))) ,
            n_nonSV = sum(is.na(chr1)),
            n_nonVDJ_SV = sum(!(is.na(chr1)) & VDJlocus==FALSE))

SVperColonyInfo = merge(SVperColony, m3final, by="colony")
write.table(SVperColonyInfo, file="SVperColonyInfo", col.names = T, row.names = F, quote=F, sep="\t")
```

# Statistical tests: test increase in SVs compared with HSC
```{r}
t.test(x=subset(SVperColonyInfo, Cell.type2=="HSC")$nSV, y=subset(SVperColonyInfo, Cell.type2!="HSC")$nSV)
# t = -32.551, df = 634, p-value < 2.2e-16
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -1.716560 -1.521235
# sample estimates:
# mean of x mean of y 
#  0.000000  1.618898 
```

# Statistical tests: gathering random stats for paper
```{r}
# proportion of SVs that are deletions
brassfilteredTPnodupNonASCAT = brassfilteredTPnodupFinal[grep(brassfilteredTPnodupFinal$svclass, invert=T, pattern="ascat"), ]
#write.table(brassfilteredTPnodupNonASCAT, file="brassfilteredTPnodupNonASCAT_July2020.txt", quote=F, sep="\t", col.names = T, row.names = F)
brassfilteredTPFinalNonASCAT = brassfilteredTPFinal[grep(brassfilteredTPFinal$svclass, invert=T, pattern="ascat"), ]
table(brassfilteredTPFinal$svclass)
 # 833 / 1026 deletions - 81% - (not including ascat gain/loss)

# proportion of SVs that are non-VDJ
mean(brassfilteredTPFinalNonASCAT$VDJlocus != FALSE) # 85%

# proportion of colonies (lymphocyte) with a non VDJ SV
mean(subset(SVperColonyInfo, Cell.type2!="HSC")$n_nonVDJ_SV > 0)
mean(subset(SVperColonyInfo, Cell.type2!="HSC")$nSV > 0)

# SV's naive vs memory
t.test(x=subset(SVperColonyInfo, Cell.type2 %in% c("T Naive ","B Naive") )$n_nonVDJ_SV>0, y=subset(SVperColonyInfo, Cell.type2 %in% c("T Memory","B Memory") )$n_nonVDJ_SV>0)
SVperColonyInfo %>%
  group_by(Cell.type2) %>%
  summarise(mean.nonvdj.min1 = mean(n_nonVDJ_SV>0))
#   Cell.type2 mean.nonvdj.min1
#   <chr>                 <dbl>
# 1 B Memory             0.270 
# 2 B Naive              0.0471
# 3 HSC                  0     
# 4 T Memory             0.25  
# 5 T Naive              0.151 
# 6 Treg                 0 

mean(subset(SVperColonyInfo, Cell.type2 %in% c("T Naive","B Naive") )$n_nonVDJ_SV>0)
mean(subset(SVperColonyInfo, Cell.type2 %in% c("T Memory","B Memory") )$n_nonVDJ_SV>0)
```


# RAG analysis
```{r}
# RAG results (Th)
rag = read.table(file="RAGmotifs/results_p10e4_obs_control_fimo_RAGheptamer_fullmotif_20200710_brassfiltered_all_July2020.txt", header = T, sep="\t") 
rag$IDsample = paste(rag$chr1, rag$start1, rag$start2, rag$sample, sep="_")
ragfinal = rag[rag$IDsample %in% brassfilteredTPnodupNonASCAT$IDsample, ]  
```

# Telomere analsis
```{r}
telo = read.table("../colonyinfo_telo_AX001_KX001_KX002_KX003_TX001_TX002_CB001.txt", header=TRUE, stringsAsFactors = F, sep="\t")
SVperColonyInfo_telo = merge(SVperColonyInfo, telo[,c("colony","Telomere")], by="colony") 
SVperColonyInfo_telo$nonVDJ_SV_TF = 0
SVperColonyInfo_telo$nonVDJ_SV_TF[SVperColonyInfo_telo$n_nonVDJ_SV>0] = 1

# no correlation between telomere length and non-vdj SV #
summary(lm(n_nonVDJ_SV~Telomere*Cell.type2, data=subset(SVperColonyInfo_telo, Cell.type2 != "HSC" )))

summary(glm(nonVDJ_SV_TF~Telomere*Age, family=binomial, data=subset(SVperColonyInfo_telo, (Cell.type2 == "T Memory" | Cell.type2 == "T Naive" ) & Age != 0 & Age !=4 )))

summary(glm(nonVDJ_SV_TF~Nmut_adj_as*Donor, family=binomial, data=subset(SVperColonyInfo_telo, (Cell.type2 == "T Memory" | Cell.type2 == "T Naive" ) & Age != 0 & Age !=4 )))


subset(SVperColonyInfo_telo, (Cell.type2 == "T Memory" | Cell.type2 == "T Naive" ) & Age != 0 & Age !=4 )

t.test(x=subset(SVperColonyInfo_telo, Cell.type2 == "T Memory" & Donor=="KX001" & n_nonVDJ_SV==0)$Nmut_adj_as,
       y=subset(SVperColonyInfo_telo, Cell.type2 == "T Memory" & Donor=="KX001" & n_nonVDJ_SV>0)$Nmut_adj_as)
t.test(x=subset(SVperColonyInfo_telo, Cell.type2 == "T Memory" & Donor=="KX002" & n_nonVDJ_SV==0)$Nmut_adj_as,
       y=subset(SVperColonyInfo_telo, Cell.type2 == "T Memory" & Donor=="KX002" & n_nonVDJ_SV>0)$Nmut_adj_as)
t.test(x=subset(SVperColonyInfo_telo, Cell.type2 == "T Memory" & Donor=="ARG" & n_nonVDJ_SV==0)$Nmut_adj_as, 
       y=subset(SVperColonyInfo_telo, Cell.type2 == "T Memory" & Donor=="ARG" & n_nonVDJ_SV>0)$Nmut_adj_as)



summary(glm(nonVDJ_SV_TF~Nmut_adj_as+Age, family=binomial, data=subset(SVperColonyInfo_telo, (Cell.type2 == "T Memory" | Cell.type2 == "T Naive" | Cell.type2 == "Treg") )))



summary(lm(n_nonVDJ_SV~Nmut_adj_as*Cell.type2, data=subset(SVperColonyInfo_telo, Cell.type2 != "HSC" )))

ggplot(data=subset(SVperColonyInfo_telo, Cell.type2 != "HSC" ), aes(n_nonVDJ_SV,Nmut_adj_as) )+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_wrap(.~Cell.type2, scales="free")

ggplot(data=subset(SVperColonyInfo_telo, Cell.type2 %in% c("T Memory","T Naive")), aes(n_nonVDJ_SV,Telomere) )+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_grid(Donor~Cell.type2, scales="free")
ggplot(data=subset(SVperColonyInfo_telo, Cell.type2 %in% c("T Memory","T Naive")), aes(nonVDJ_SV_TF,Nmut_adj_as) )+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_grid(Donor~Cell.type2, scales="free")


sv_telo_sum = subset(SVperColonyInfo_telo, Cell.type2 != "HSC" ) %>%
	group_by(Cell.type2, Age) %>%
	summarize(
    mean_min1nonVDJ = mean(n_nonVDJ_SV>0),
    mean_nonVDJ = mean(n_nonVDJ_SV),
    n = n()
    )
ggplot(sv_telo_sum, aes(Age, mean_nonVDJ))+
  geom_point(aes(color=Cell.type2))



sv_telo_sum = subset(SVperColonyInfo_telo, Cell.type2 %in% c("T Naive","T Memory") ) %>%
	group_by(Cell.type2, Age, n_nonVDJ_SV>0) %>%
	summarize(
    mean_min1nonVDJ = mean(n_nonVDJ_SV>0),
    mean_telomere = mean(Telomere),
    mean_nonVDJ = mean(n_nonVDJ_SV),
    n = n()
    )
```
# Non-VDJ with age
```{r}
SVperColonyInfo = read.table(file="SVperColonyInfo", header=T, stringsAsFactors = F, sep="\t")
summary(lm(n_nonVDJ_SV~Age , data=subset(SVperColonyInfo, Cell.type2 %in% c("B Memory","T Memory"))))
ggplot(subset(SVperColonyInfo, Cell.type2 %in% c("B Memory","T Memory", "B Naive", "T Naive")) )+
  geom_boxplot(aes(y=n_nonVDJ_SV, group=Age))


subset(SVperColonyInfo, Cell.type2 %in% c("B Memory","T Memory", "B Naive", "T Naive")) %>%
  group_by(Age, Cell.type2) %>%
  summarise(mean = mean(n_nonVDJ_SV))
```